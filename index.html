<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Коммент‑маркетинг — дашборд</title>

    <!-- Tailwind (CSS only) -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- React / ReactDOM (2 CDNs for reliability) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Recharts (2 CDNs for reliability) -->
    <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <script crossorigin src="https://cdn.jsdelivr.net/npm/recharts/umd/Recharts.min.js"></script>

    <style>
      ::-webkit-scrollbar { height: 8px; width: 8px; }
      ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 9999px; }
    </style>
  </head>
  <body class="bg-slate-50 text-slate-900">
    <noscript>
      <div class="max-w-2xl mx-auto m-6 p-4 bg-white rounded-xl shadow border text-sm">
        Для отображения дашборда требуется JavaScript.
      </div>
    </noscript>

    <div id="root" class="p-4 md:p-8 max-w-6xl mx-auto"></div>

    <script>
      // ---------- Safety checks for CDN libs ----------
      (function ensureLibs() {
        const el = document.getElementById('root');
        function fail(msg) {
          el.innerHTML = `
            <div class="max-w-2xl mx-auto m-6 p-4 bg-white rounded-xl shadow border">
              <div class="font-semibold mb-2">Не удалось загрузить библиотеки</div>
              <div class="text-sm text-slate-700 mb-3">${msg}</div>
              <ol class="list-decimal pl-5 text-sm text-slate-700 space-y-1">
                <li>Проверьте, что сеть не блокирует <code>unpkg.com</code> и <code>cdn.jsdelivr.net</code>.</li>
                <li>Откройте файл через локальный сервер: <code>python3 -m http.server 8000</code> и перейдите на <code>http://localhost:8000</code>.</li>
                <li>Или выложите файл на GitHub Pages.</li>
              </ol>
            </div>`;
          throw new Error('Required CDN libraries are missing');
        }
        if (!window.React || !window.ReactDOM) {
          fail('React / ReactDOM не загрузились.');
        }
        if (!window.Recharts) {
          fail('Recharts не загрузился.');
        }
      })();

      const { useEffect, useMemo, useState } = React;
      const RechartsLib = window.Recharts;
      const { ResponsiveContainer, BarChart, Bar, XAxis, YAxis, CartesianGrid, Tooltip } = RechartsLib;

      // ---------- helpers ----------
      const ruMonthName = (ym) => {
        const [y, m] = (ym || '').split('-').map(Number);
        if (!y || !m) return ym || '';
        const date = new Date(y, m - 1, 1);
        return date.toLocaleDateString('ru-RU', { month: 'long', year: 'numeric' })
          .replace(/^./, (c) => c.toUpperCase());
      };

      const unique = (arr) => Array.from(new Set(arr || []));
      const normPerson = (s) => (s || '').trim().toLowerCase();

      const PERSONS = ['Раф', 'Петя'];
      const PLATFORMS = ['YouTube', 'Instagram', 'TikTok'];
      const TAB_ALL = 'По всем площадкам';

      const sampleEntries = [
        { person: 'Раф', platform: 'YouTube', month: '2025-09', reactions: 120 },
        { person: 'Раф', platform: 'Instagram', month: '2025-09', reactions: 95 },
        { person: 'Раф', platform: 'TikTok', month: '2025-09', reactions: 60 },
        { person: 'Петя', platform: 'YouTube', month: '2025-09', reactions: 80 },
        { person: 'Петя', platform: 'Instagram', month: '2025-09', reactions: 110 },
        { person: 'Петя', platform: 'TikTok', month: '2025-09', reactions: 40 },
        // Октябрь
        { person: 'Раф', platform: 'YouTube', month: '2025-10', reactions: 140 },
        { person: 'Раф', platform: 'Instagram', month: '2025-10', reactions: 120 },
        { person: 'Раф', platform: 'TikTok', month: '2025-10', reactions: 80 },
        { person: 'Петя', platform: 'YouTube', month: '2025-10', reactions: 100 },
        { person: 'Петя', platform: 'Instagram', month: '2025-10', reactions: 130 },
        { person: 'Петя', platform: 'TikTok', month: '2025-10', reactions: 55 },
        // Ноябрь
        { person: 'Раф', platform: 'YouTube', month: '2025-11', reactions: 160 },
        { person: 'Раф', platform: 'Instagram', month: '2025-11', reactions: 150 },
        { person: 'Раф', platform: 'TikTok', month: '2025-11', reactions: 90 },
        { person: 'Петя', platform: 'YouTube', month: '2025-11', reactions: 120 },
        { person: 'Петя', platform: 'Instagram', month: '2025-11', reactions: 140 },
        { person: 'Петя', platform: 'TikTok', month: '2025-11', reactions: 70 },
      ];

      // ---------- UI ----------
      function Pill({ active, onClick, children }) {
        return React.createElement('button', {
          onClick,
          className: `px-3 py-1.5 rounded-full text-xs md:text-sm transition ${active ? 'bg-slate-900 text-white' : 'bg-slate-200 text-slate-800 hover:bg-slate-300'}`
        }, children);
      }

      function Panel({ title, children, right }) {
        return React.createElement('div', { className: 'bg-white rounded-2xl shadow p-4 md:p-6 border border-slate-200' },
          React.createElement('div', { className: 'flex items-center justify-between gap-4 mb-4' },
            React.createElement('h2', { className: 'text-lg md:text-xl font-semibold' }, title),
            right || null
          ),
          children
        );
      }

      function App() {
        const [entries, setEntries] = useState(null);
        const [person, setPerson] = useState('Раф');
        const [platform, setPlatform] = useState('YouTube');

        useEffect(() => {
          // NOTE: When opened via file://, fetch may fail due to browser restrictions.
          // We fall back to sampleEntries in catch.
          fetch('./data.json', { cache: 'no-cache' })
            .then(r => r.ok ? r.json() : Promise.reject(new Error('Нет data.json')))
            .then(json => setEntries(Array.isArray(json.entries) ? json.entries : sampleEntries))
            .catch(() => setEntries(sampleEntries));
        }, []);

        const months = useMemo(() => {
          if (!entries) return [];
          const mm = unique(entries.map(e => e.month)).sort();
          return mm;
        }, [entries]);

        const chartData = useMemo(() => {
          if (!entries) return [];
          const persons = person === 'Суммарное' ? PERSONS : [person];
          return months.map(m => {
            let value = 0;
            persons.forEach(p => {
              if (platform === TAB_ALL) {
                PLATFORMS.forEach(pl => {
                  entries.filter(e => e.person && normPerson(e.person) === normPerson(p))
                         .filter(e => e.platform === pl && e.month === m)
                         .forEach(e => { value += Number(e.reactions) || 0; });
                });
              } else {
                entries.filter(e => e.person && normPerson(e.person) === normPerson(p))
                       .filter(e => e.platform === platform && e.month === m)
                       .forEach(e => { value += Number(e.reactions) || 0; });
              }
            });
            return { month: ruMonthName(m), reactions: value };
          });
        }, [entries, person, platform, months]);

        const total = useMemo(() => chartData.reduce((s, r) => s + (Number(r.reactions) || 0), 0), [chartData]);

        if (!entries) {
          return React.createElement('div', { className: 'text-slate-500' }, 'Загрузка…');
        }

        return React.createElement('div', { className: 'space-y-6' },
          React.createElement('header', { className: 'flex items-center justify-between gap-4' },
            React.createElement('h1', { className: 'text-2xl md:text-3xl font-bold' }, 'Коммент‑маркетинг — дашборд'),
            React.createElement('div', { className: 'text-sm text-slate-500' }, 'Статичный сайт (GitHub Pages)')
          ),

          React.createElement(Panel, { title: 'Фильтры' },
            React.createElement('div', { className: 'flex flex-wrap gap-2 items-center' },
              ['Раф', 'Петя', 'Суммарное'].map(p =>
                React.createElement(Pill, { key: p, active: person === p, onClick: () => setPerson(p) }, p)
              ),
              React.createElement('span', { className: 'mx-2 text-slate-300' }, '•'),
              ['YouTube', 'Instagram', 'TikTok', 'По всем площадкам'].map(pl =>
                React.createElement(Pill, { key: pl, active: platform === pl, onClick: () => setPlatform(pl) }, pl)
              ),
            )
          ),

          React.createElement(Panel, {
            title: `${person} — ${platform}`,
            right: React.createElement('div', { className: 'text-sm text-slate-600' }, `Итого: ${total.toLocaleString('ru-RU')}`)
          },
            React.createElement('div', { className: 'h-80 w-full' },
              React.createElement(ResponsiveContainer, null,
                React.createElement(BarChart, { data: chartData, margin: { top: 10, right: 20, left: 0, bottom: 0 } },
                  React.createElement(CartesianGrid, { strokeDasharray: '3 3' }),
                  React.createElement(XAxis, { dataKey: 'month' }),
                  React.createElement(YAxis, { allowDecimals: false }),
                  React.createElement(Tooltip, null),
                  React.createElement(Bar, { dataKey: 'reactions', name: 'Реакции' })
                )
              )
            )
          ),

          React.createElement(Panel, { title: 'Сырые данные (текущий срез)' },
            React.createElement('div', { className: 'overflow-x-auto' },
              React.createElement('table', { className: 'min-w-full text-sm' },
                React.createElement('thead', { className: 'text-left text-slate-500' },
                  React.createElement('tr', null,
                    React.createElement('th', { className: 'py-2 pr-4' }, 'Персона'),
                    React.createElement('th', { className: 'py-2 pr-4' }, 'Площадка'),
                    React.createElement('th', { className: 'py-2 pr-4' }, 'Месяц'),
                    React.createElement('th', { className: 'py-2 pr-4' }, 'Реакции')
                  )
                ),
                React.createElement('tbody', null,
                  (entries || []).map((e, i) => (
                    React.createElement('tr', { key: i, className: i % 2 ? 'bg-slate-50' : '' },
                      React.createElement('td', { className: 'py-2 pr-4' }, e.person || ''),
                      React.createElement('td', { className: 'py-2 pr-4' }, e.platform || ''),
                      React.createElement('td', { className: 'py-2 pr-4' }, ruMonthName(e.month)),
                      React.createElement('td', { className: 'py-2 pr-4' }, Number(e.reactions || 0).toLocaleString('ru-RU'))
                    )
                  ))
                )
              )
            )
          )
        );
      }

      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(App));
    </script>
  </body>
</html>
